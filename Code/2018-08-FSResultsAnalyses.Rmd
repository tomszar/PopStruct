---
title: "Analysis of FineStructure Results"
output: html_document
---

This script uses the R library from Daniel Lawson, located [here](https://people.maths.bris.ac.uk/~madjl/finestructure/finestructureR.html).

```{r load libraries}
source("FinestructureLibrary.R")
library(tidyverse)
library(dendextend)
#library(gplots)
library(heatmap3)
```

Read the databases

```{r databases, warning=FALSE}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/FineStructure", sep = ""))

#Read the chunkout file
dataraw <- as.matrix(read.table("merge_fs_linked.chunkcounts.out", row.names=1, header=T, skip=1)) #read in the pairwise coincidence 
#Fixing ID names
attributes(dataraw)$dimnames[[2]] <- attributes(dataraw)$dimnames[[1]] 

#Read the mcmc files
mcmcxml  <- xmlTreeParse("merge_fs_linked_mcmc.xml") ## read into xml format
mcmcdata <- as.data.frame.myres(mcmcxml) 

#Read the tree file
treexml <- xmlTreeParse("merge_fs_linked_tree.xml") ## read the tree as xml format
ttree   <- extractTree(treexml) ## extract the tree into ape's phylo format
## If you dont want to plot internal node labels (i.e. MCMC posterior assignment probabilities)
## now is a good time to remove them via:
ttree$node.label<-NULL
## Will will instead remove "perfect" node labels
#ttree$node.label[ttree$node.label=="1"] <-""
## And reduce the amount of significant digits printed:
#ttree$node.label[ttree$node.label!=""] <-format(as.numeric(ttree$node.label[ttree$node.label!=""]),digits=2)
tdend   <- myapetodend(ttree,factor=1) # convert to dendrogram format
#The probabilities are stored as edgetext in dendrogram object

#Get pops
mapstate     <- extractValue(treexml,"Pop") # map state as a finestructure clustering
mapstatelist <- popAsList(mapstate) # .. and as a list of individuals in populations
popnames     <- paste("Pop", seq(1:length(mapstatelist)), sep="_")
names(mapstatelist) <- popnames
```

The fineSTRUCTURE analysis generated a total of `r cut(tdend, h = 0.05)$upper %>% nleaves` clusters, from the total of `r tdend %>% nleaves` individuals.
The maximum number of individuals per cluster is of `r sapply(mapstatelist, function(x) length(x)) %>% max` and the minimum of `r sapply(mapstatelist, function(x) length(x)) %>% min`


## Plot dendograms

```{r dendograms, fig.width=25, fig.height=15}
popdendclear <- makemydend(tdend,mapstatelist,"NameMoreSummary")# use NameMoreSummary to make popdend
#popdendclear<-fixMidpointsComplete(popdendclear) # needed for obscure dendrogram reasons
labels(popdendclear) <- popnames
popdendclear %>% plot
```

## Plot coancestry matrix

```{r pairwise coincidence}

fullorder  <- labels(tdend) # the order according to the tree
datamatrix <- dataraw[fullorder, fullorder] # reorder the data matrix
tmatmax<-500 # cap the heatmap
tmpmat<-datamatrix 
tmpmat[tmpmat>tmatmax]<-tmatmax # 
some.colors<-MakeColorYRP() # these are yellow-red-purple
some.colorsEnd<-MakeColorYRP(final=c(0.2,0.2,0.2)) # as above, but with a dark grey final for capped values

mappopcorrectorder<-NameExpand(labels(popdendclear))
mappopsizes<-sapply(mappopcorrectorder,length)
labellocs<-PopCenters(mappopsizes)
labelcols<-c(2,2,3,3,4,4,1,1,1,5,6,6,6,7,8,8,2) # different label colours allow clearer identification of individuals, too
labelcrt=45

test = tmpmat[1:1000,1:1000]
pdf(file="Coancestry1.pdf",height=10,width=10)
plotFinestructure(test, dimnames(test)[[1]],labelsx=labels(popdendclear), labelsatx=labellocs,crt=labelcrt, text.col=labelcols,
                  cex.axis=1.0, edgePar = list(p.lwd=0, t.srt=90, t.off=-0.1, t.cex=0.8))
dev.off()

test = tmpmat[1000:2000, 1000:2000]
pdf(file="Coancestry2.pdf",height=10,width=10)
plotFinestructure(test, dimnames(test)[[1]],labelsx=labels(popdendclear), labelsatx=labellocs,crt=labelcrt, text.col=labelcols,
                  cex.axis=1.0, edgePar = list(p.lwd=0, t.srt=90, t.off=-0.1, t.cex=0.8))
dev.off()

test = tmpmat[2000:2967, 2000:2967]
pdf(file="Coancestry3.pdf",height=10,width=10)
plotFinestructure(test, dimnames(test)[[1]],labelsx=labels(popdendclear), labelsatx=labellocs,
                  crt=labelcrt, text.col=labelcols,cex.axis=1.0, edgePar = list(p.lwd=0, t.srt=90, 
                                                                                t.off=-0.1, t.cex=0.8))
dev.off()
```

```{r}
#Cut the dendrogram from top to bottom (k = 1 to k = 6)
newtree <- as.data.frame(cutree(tdend, k = 2))
for (i in 3:10){
  newtree <- cbind(newtree, as.data.frame(cutree(tdend, k = i)))
}

colnames(newtree) <- paste("k", (2:10), sep="")

#Saving clustering 
setwd(paste(path, "/Results/FineStructure", sep = ""))
write.table(newtree, "fs_clust.csv",  sep=",", 
            quote = FALSE, col.names = FALSE, row.names = TRUE)
```

